<?xml version="1.0" encoding="utf-8" ?>
<UserControl
    x:Class="Oxygen.Editor.WorldEditor.Inspector.SceneNodeEditorView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="using:DroidNet.Controls"
    xmlns:ctk="using:CommunityToolkit.WinUI.Controls"
    xmlns:ctkcvt="using:CommunityToolkit.WinUI.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="using:Oxygen.Editor.WorldEditor.Inspector"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:menus="using:DroidNet.Controls.Menus"
    xmlns:muxc="using:Microsoft.UI.Xaml.Controls"
    x:Name="Root"
    KeyboardAcceleratorPlacementMode="Hidden"
    mc:Ignorable="d">

    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="ms-appx:///Oxygen.Editor.WorldEditor/Styles/GridSplitterStyles.xaml" />
            </ResourceDictionary.MergedDictionaries>

            <ResourceDictionary.ThemeDictionaries>
                <ResourceDictionary x:Key="Default">
                    <AcrylicBrush
                        x:Key="InspectorTopBackground"
                        FallbackColor="#1F1F1F"
                        TintColor="#FF1F1F1F"
                        TintOpacity="0.60" />
                </ResourceDictionary>
                <ResourceDictionary x:Key="Light">
                    <AcrylicBrush
                        x:Key="InspectorTopBackground"
                        FallbackColor="#FFFFFF"
                        TintColor="#FFFFFFFF"
                        TintOpacity="0.70" />
                </ResourceDictionary>
                <ResourceDictionary x:Key="Dark">
                    <AcrylicBrush
                        x:Key="InspectorTopBackground"
                        FallbackColor="#1E1E1E"
                        TintColor="#FF2B2B2B"
                        TintOpacity="0.30" />
                </ResourceDictionary>
                <ResourceDictionary x:Key="HighContrast">
                    <SolidColorBrush x:Key="InspectorTopBackground" Color="{ThemeResource LayerFillColorDefaultBrush}" />
                </ResourceDictionary>
            </ResourceDictionary.ThemeDictionaries>

            <local:ItemsTypeToIconConverter x:Key="ItemsTypeToIconConverter" />
            <ctkcvt:BoolToVisibilityConverter x:Key="HasSelectionToVisibilityConverter" />
        </ResourceDictionary>
    </UserControl.Resources>

    <UserControl.KeyboardAccelerators>
        <KeyboardAccelerator
            Key="Z"
            Invoked="UndoInvoked"
            Modifiers="Control" />
        <KeyboardAccelerator
            Key="Y"
            Invoked="RedoInvoked"
            Modifiers="Control" />
    </UserControl.KeyboardAccelerators>

    <Grid Padding="4">
        <Grid.Resources>
            <ResourceDictionary Source="ms-appx:///Microsoft.UI.Xaml/DensityStyles/Compact.xaml" />
        </Grid.Resources>

        <TextBlock
            Margin="10,40"
            VerticalAlignment="Top"
            FontStyle="Italic"
            Foreground="{ThemeResource TextFillColorTertiaryBrush}"
            Style="{ThemeResource CaptionTextBlockStyle}"
            Text="Select an object to view and edit its properties"
            TextAlignment="Center"
            TextWrapping="WrapWholeWords"
            Visibility="{x:Bind ViewModel.HasItems, Mode=OneWay, Converter={StaticResource HasSelectionToVisibilityConverter}, ConverterParameter=True}" />

        <Grid Visibility="{x:Bind ViewModel.HasItems, Mode=OneWay, Converter={StaticResource HasSelectionToVisibilityConverter}, ConverterParameter=False}">
            <Grid.RowDefinitions>
                <RowDefinition Height="2*" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="3*" />
            </Grid.RowDefinitions>

            <!--  Top pane: header + components  -->
            <Border
                Grid.Row="0"
                Padding="8"
                Background="{ThemeResource InspectorTopBackground}">
                <Grid HorizontalAlignment="Stretch">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="44" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" MinWidth="100" />
                    </Grid.ColumnDefinitions>

                    <!--  Single-selection details (header + components list).  -->
                    <local:SceneNodeDetailsView
                        Grid.RowSpan="2"
                        Grid.ColumnSpan="3"
                        HistoryRoot="{x:Bind ViewModel, Mode=OneWay}"
                        LoggerFactory="{x:Bind ViewModel.LoggerFactory}"
                        Node="{x:Bind ViewModel.SelectedNode, Mode=OneWay}"
                        Visibility="{x:Bind ViewModel.IsSingleItemSelected, Mode=OneWay, Converter={StaticResource HasSelectionToVisibilityConverter}, ConverterParameter=False}" />

                    <!--  Multi-selection header (no components list, no add/delete).  -->
                    <ContentPresenter
                        Grid.Row="0"
                        Margin="0,0,8,0"
                        VerticalAlignment="Center"
                        Content="{x:Bind ViewModel.ItemsType, Mode=OneWay, Converter={StaticResource ItemsTypeToIconConverter}}"
                        Visibility="{x:Bind ViewModel.IsSingleItemSelected, Mode=OneWay, Converter={StaticResource HasSelectionToVisibilityConverter}, ConverterParameter=True}" />

                    <TextBlock
                        Grid.Row="0"
                        Grid.Column="2"
                        Margin="20,0,4,0"
                        HorizontalAlignment="Left"
                        VerticalAlignment="Center"
                        Visibility="{x:Bind ViewModel.HasMultipleItems, Mode=OneWay, Converter={StaticResource HasSelectionToVisibilityConverter}, ConverterParameter=False}">
                        <Run Text="{x:Bind ViewModel.ItemsCount, Mode=OneWay}" />
                        <Run Text="Objects" />
                    </TextBlock>
                </Grid>
            </Border>

            <!--  Splitter  -->
            <ctk:GridSplitter
                Grid.Row="1"
                Grid.ColumnSpan="3"
                Height="8"
                Style="{StaticResource InvisibleGridSplitterStyle}" />

            <!--  Bottom pane: property editors  -->
            <ScrollViewer
                Grid.Row="2"
                Padding="4,0,4,4"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch"
                HorizontalScrollBarVisibility="Disabled"
                HorizontalScrollMode="Disabled"
                VerticalScrollBarVisibility="Auto"
                VerticalScrollMode="Auto">
                <ItemsRepeater
                    HorizontalAlignment="Stretch"
                    ItemsSource="{x:Bind ViewModel.PropertyEditors}"
                    TabFocusNavigation="Local">
                    <ItemsRepeater.Layout>
                        <muxc:StackLayout Orientation="Vertical" Spacing="4" />
                    </ItemsRepeater.Layout>
                    <ItemsRepeater.ItemTemplate>
                        <DataTemplate x:DataType="local:IDetailsSection">
                            <!--  ReSharper disable once Xaml.StaticResourceNotResolved (created in code behind)  -->
                            <ContentPresenter Content="{x:Bind Converter={StaticResource VmToViewConverter}}" />
                        </DataTemplate>
                    </ItemsRepeater.ItemTemplate>
                </ItemsRepeater>
            </ScrollViewer>
        </Grid>
    </Grid>
</UserControl>
