<?xml version="1.0" encoding="utf-8" ?>

<ResourceDictionary
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="using:DroidNet.Controls"
    xmlns:ctk="using:CommunityToolkit.WinUI.Converters"
    xmlns:cvt="using:DroidNet.Converters">

    <ResourceDictionary.ThemeDictionaries>
        <ResourceDictionary x:Key="Light">
            <SolidColorBrush
                x:Key="TabStripItemOverlayBrush"
                Opacity="0.85"
                Color="#D3D3D3" />
            <SolidColorBrush
                x:Key="TabStripItemButtonBrush"
                Opacity="0.1"
                Color="#FFFFFF" />
        </ResourceDictionary>
        <ResourceDictionary x:Key="Dark">
            <SolidColorBrush
                x:Key="TabStripItemOverlayBrush"
                Opacity="0.85"
                Color="#2C2C2C" />
            <SolidColorBrush
                x:Key="TabStripItemButtonBrush"
                Opacity="0.01"
                Color="#FFFFFF" />
        </ResourceDictionary>
        <ResourceDictionary x:Key="HighContrast">
            <!--  High contrast: fully opaque black so system foreground remains readable  -->
            <SolidColorBrush x:Key="TabStripItemOverlayBrush" Color="#FF000000" />
            <SolidColorBrush x:Key="TabStripItemButtonBrush" Color="#FF000000" />
        </ResourceDictionary>
    </ResourceDictionary.ThemeDictionaries>

    <ctk:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
    <cvt:NullToVisibilityConverter x:Key="NullToVisibilityConverter" />

    <Style BasedOn="{StaticResource DefaultTabStripItemStyle}" TargetType="controls:TabStripItem" />

    <!--  TabStrip default style  -->
    <Style x:Key="DefaultTabStripItemStyle" TargetType="controls:TabStripItem">
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="controls:TabStripItem">
                    <!--
                        Outer grid: holds the measured content grid (PartRootGrid) and a sibling overlay layer for tool buttons.
                        Keeping the overlay as a sibling ensures the measured PartRootGrid does not include tool buttons in its desired size.
                    -->
                    <Grid x:Name="PartRootGrid">
                        <Grid.RenderTransform>
                            <ScaleTransform />
                        </Grid.RenderTransform>
                        <!--  Highlight background rectangle (spans full width)  -->
                        <Border
                            x:Name="HighlightRect"
                            Background="Transparent"
                            CornerRadius="4,4,0,0"
                            IsHitTestVisible="False"
                            Opacity="0" />

                        <!--  Main measured layout grid (this is the grid the control code measures)  -->
                        <Grid
                            x:Name="PartContentRootGrid"
                            Height="32"
                            Background="Transparent"
                            ColumnSpacing="8"
                            DataContext="{TemplateBinding Item}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <!--  Icon  -->
                            <IconSourceElement
                                x:Name="PartIcon"
                                Grid.Column="0"
                                Margin="8,0,0,0"
                                VerticalAlignment="Center"
                                IconSource="{Binding Icon, Mode=OneWay}"
                                Visibility="{Binding Icon, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}" />

                            <!--  Header  -->
                            <TextBlock
                                x:Name="PartHeader"
                                Grid.Column="1"
                                HorizontalAlignment="Left"
                                VerticalAlignment="Center"
                                Text="{Binding Header, Mode=OneWay}"
                                TextTrimming="CharacterEllipsis" />

                            <!--  Pinned indicator circle  -->
                            <Ellipse
                                x:Name="PartPinnedIndicator"
                                Grid.Column="0"
                                Width="4"
                                Height="4"
                                Margin="1,1,0,0"
                                HorizontalAlignment="Left"
                                VerticalAlignment="Top"
                                Fill="{ThemeResource AccentFillColorDefaultBrush}"
                                Visibility="{Binding IsPinned, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}" />
                        </Grid>

                        <!--
                            Overlay sibling: sizes to its content (anchored right), stretches vertically so content can be centered.
                            Bind DataContext to the templated Item so inner button bindings resolve.
                        -->
                        <Grid
                            x:Name="OverlayPanel"
                            Margin="2"
                            Padding="4"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Stretch"
                            Background="{ThemeResource TabStripItemOverlayBrush}"
                            CornerRadius="4"
                            DataContext="{TemplateBinding Item}"
                            IsHitTestVisible="False"
                            Opacity="0">
                            <StackPanel
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Center"
                                Orientation="Horizontal"
                                Spacing="4">
                                <!--  Buttons container is inside overlay so buttons overlay the item; overlay is sibling to the measured PartRootGrid  -->
                                <StackPanel
                                    x:Name="ButtonsContainer"
                                    Margin="0"
                                    HorizontalAlignment="Right"
                                    VerticalAlignment="Center"
                                    Orientation="Horizontal"
                                    Spacing="4">
                                    <!--  Pin button  -->
                                    <Button
                                        x:Name="PartPinButton"
                                        Width="20"
                                        Height="20"
                                        Padding="0"
                                        Background="{ThemeResource TabStripItemButtonBrush}"
                                        BorderThickness="0"
                                        IsHitTestVisible="False">
                                        <Button.Content>
                                            <FontIcon
                                                FontFamily="{ThemeResource SymbolThemeFontFamily}"
                                                FontSize="10"
                                                Foreground="{ThemeResource SystemControlForegroundBaseHighBrush}" />
                                        </Button.Content>
                                    </Button>
                                    <!--  Close button  -->
                                    <Button
                                        x:Name="PartCloseButton"
                                        Width="20"
                                        Height="20"
                                        Padding="0"
                                        Background="{ThemeResource TabStripItemButtonBrush}"
                                        BorderThickness="0"
                                        Command="{Binding Command}"
                                        CommandParameter="{Binding CommandParameter}"
                                        IsHitTestVisible="False"
                                        Visibility="{Binding IsClosable, Converter={StaticResource BoolToVisibilityConverter}}">
                                        <Button.Content>
                                            <FontIcon
                                                FontFamily="{ThemeResource SymbolThemeFontFamily}"
                                                FontSize="10"
                                                Foreground="{ThemeResource SystemControlForegroundBaseHighBrush}"
                                                Glyph="&#xE8BB;" />
                                        </Button.Content>
                                    </Button>
                                </StackPanel>
                            </StackPanel>
                        </Grid>

                        <VisualStateManager.VisualStateGroups>
                            <VisualStateGroup x:Name="CommonStates">
                                <VisualState x:Name="Normal">
                                    <Storyboard>
                                        <ObjectAnimationUsingKeyFrames Storyboard.TargetName="HighlightRect" Storyboard.TargetProperty="Background">
                                            <DiscreteObjectKeyFrame KeyTime="0:0:0" Value="Transparent" />
                                        </ObjectAnimationUsingKeyFrames>
                                        <DoubleAnimation
                                            Storyboard.TargetName="HighlightRect"
                                            Storyboard.TargetProperty="Opacity"
                                            To="0"
                                            Duration="0:0:0.1" />
                                    </Storyboard>
                                </VisualState>

                                <VisualState x:Name="PointerOver">
                                    <Storyboard>
                                        <ObjectAnimationUsingKeyFrames Storyboard.TargetName="HighlightRect" Storyboard.TargetProperty="Background">
                                            <DiscreteObjectKeyFrame KeyTime="0:0:0" Value="{ThemeResource ListViewItemBackgroundPointerOver}" />
                                        </ObjectAnimationUsingKeyFrames>
                                        <DoubleAnimation
                                            Storyboard.TargetName="HighlightRect"
                                            Storyboard.TargetProperty="Opacity"
                                            To="0.5"
                                            Duration="0:0:0.1" />
                                    </Storyboard>
                                </VisualState>

                                <VisualState x:Name="Selected">
                                    <Storyboard>
                                        <ObjectAnimationUsingKeyFrames Storyboard.TargetName="HighlightRect" Storyboard.TargetProperty="Background">
                                            <DiscreteObjectKeyFrame KeyTime="0:0:0" Value="{ThemeResource ListViewItemBackgroundSelected}" />
                                        </ObjectAnimationUsingKeyFrames>
                                        <DoubleAnimation
                                            Storyboard.TargetName="HighlightRect"
                                            Storyboard.TargetProperty="Opacity"
                                            To="1"
                                            Duration="0:0:0.1" />
                                    </Storyboard>
                                </VisualState>

                                <VisualState x:Name="SelectedPointerOver">
                                    <Storyboard>
                                        <ObjectAnimationUsingKeyFrames Storyboard.TargetName="HighlightRect" Storyboard.TargetProperty="Background">
                                            <DiscreteObjectKeyFrame KeyTime="0:0:0" Value="{ThemeResource ListViewItemBackgroundSelected}" />
                                        </ObjectAnimationUsingKeyFrames>
                                        <DoubleAnimation
                                            Storyboard.TargetName="HighlightRect"
                                            Storyboard.TargetProperty="Opacity"
                                            To="1"
                                            Duration="0:0:0.1" />
                                    </Storyboard>
                                </VisualState>
                            </VisualStateGroup>
                            <!--  New group for pin glyph states  -->
                            <VisualStateGroup x:Name="PinStates">
                                <VisualState x:Name="Unpinned">
                                    <Storyboard>
                                        <ObjectAnimationUsingKeyFrames Storyboard.TargetName="PartPinButton" Storyboard.TargetProperty="(Button.Content).(FontIcon.Glyph)">
                                            <DiscreteObjectKeyFrame KeyTime="0:0:0" Value="&#xE718;" />
                                        </ObjectAnimationUsingKeyFrames>
                                    </Storyboard>
                                </VisualState>
                                <VisualState x:Name="Pinned">
                                    <Storyboard>
                                        <ObjectAnimationUsingKeyFrames Storyboard.TargetName="PartPinButton" Storyboard.TargetProperty="(Button.Content).(FontIcon.Glyph)">
                                            <DiscreteObjectKeyFrame KeyTime="0:0:0" Value="&#xE77A;" />
                                        </ObjectAnimationUsingKeyFrames>
                                    </Storyboard>
                                </VisualState>
                            </VisualStateGroup>
                            <!--
                                Overlay visibility group: toggles Visibility and animates Opacity so the overlay
                                is added/removed from the visual tree but still fades in/out.
                            -->
                            <VisualStateGroup x:Name="OverlayStates">
                                <VisualState x:Name="OverlayHidden">
                                    <Storyboard>
                                        <!--  Fade overlay out (buttons will follow visually via overlay)  -->
                                        <DoubleAnimation
                                            Storyboard.TargetName="OverlayPanel"
                                            Storyboard.TargetProperty="Opacity"
                                            To="0"
                                            Duration="0:0:0.12" />

                                        <!--  After fade completes, collapse and disable hit testing for overlay and buttons  -->
                                        <ObjectAnimationUsingKeyFrames Storyboard.TargetName="OverlayPanel" Storyboard.TargetProperty="IsHitTestVisible">
                                            <DiscreteObjectKeyFrame KeyTime="0:0:0.12">
                                                <DiscreteObjectKeyFrame.Value>
                                                    <x:Boolean>False</x:Boolean>
                                                </DiscreteObjectKeyFrame.Value>
                                            </DiscreteObjectKeyFrame>
                                        </ObjectAnimationUsingKeyFrames>
                                        <ObjectAnimationUsingKeyFrames Storyboard.TargetName="PartPinButton" Storyboard.TargetProperty="IsHitTestVisible">
                                            <DiscreteObjectKeyFrame KeyTime="0:0:0.12">
                                                <DiscreteObjectKeyFrame.Value>
                                                    <x:Boolean>False</x:Boolean>
                                                </DiscreteObjectKeyFrame.Value>
                                            </DiscreteObjectKeyFrame>
                                        </ObjectAnimationUsingKeyFrames>
                                        <ObjectAnimationUsingKeyFrames Storyboard.TargetName="PartCloseButton" Storyboard.TargetProperty="IsHitTestVisible">
                                            <DiscreteObjectKeyFrame KeyTime="0:0:0.12">
                                                <DiscreteObjectKeyFrame.Value>
                                                    <x:Boolean>False</x:Boolean>
                                                </DiscreteObjectKeyFrame.Value>
                                            </DiscreteObjectKeyFrame>
                                        </ObjectAnimationUsingKeyFrames>
                                        <ObjectAnimationUsingKeyFrames Storyboard.TargetName="OverlayPanel" Storyboard.TargetProperty="Visibility">
                                            <DiscreteObjectKeyFrame KeyTime="0:0:0.12">
                                                <DiscreteObjectKeyFrame.Value>Collapsed</DiscreteObjectKeyFrame.Value>
                                            </DiscreteObjectKeyFrame>
                                        </ObjectAnimationUsingKeyFrames>
                                    </Storyboard>
                                </VisualState>
                                <VisualState x:Name="OverlayVisible">
                                    <Storyboard>
                                        <!--  Make visible immediately so fade is seen; keep hit testing off until fade completes  -->
                                        <ObjectAnimationUsingKeyFrames Storyboard.TargetName="OverlayPanel" Storyboard.TargetProperty="Visibility">
                                            <DiscreteObjectKeyFrame KeyTime="0:0:0">
                                                <DiscreteObjectKeyFrame.Value>Visible</DiscreteObjectKeyFrame.Value>
                                            </DiscreteObjectKeyFrame>
                                        </ObjectAnimationUsingKeyFrames>
                                        <!--  ensure buttons and overlay start non-interactive until fade ends  -->
                                        <ObjectAnimationUsingKeyFrames Storyboard.TargetName="OverlayPanel" Storyboard.TargetProperty="IsHitTestVisible">
                                            <DiscreteObjectKeyFrame KeyTime="0:0:0">
                                                <DiscreteObjectKeyFrame.Value>
                                                    <x:Boolean>False</x:Boolean>
                                                </DiscreteObjectKeyFrame.Value>
                                            </DiscreteObjectKeyFrame>
                                            <DiscreteObjectKeyFrame KeyTime="0:0:0.12">
                                                <DiscreteObjectKeyFrame.Value>
                                                    <x:Boolean>True</x:Boolean>
                                                </DiscreteObjectKeyFrame.Value>
                                            </DiscreteObjectKeyFrame>
                                        </ObjectAnimationUsingKeyFrames>
                                        <ObjectAnimationUsingKeyFrames Storyboard.TargetName="PartPinButton" Storyboard.TargetProperty="IsHitTestVisible">
                                            <DiscreteObjectKeyFrame KeyTime="0:0:0">
                                                <DiscreteObjectKeyFrame.Value>
                                                    <x:Boolean>False</x:Boolean>
                                                </DiscreteObjectKeyFrame.Value>
                                            </DiscreteObjectKeyFrame>
                                            <DiscreteObjectKeyFrame KeyTime="0:0:0.12">
                                                <DiscreteObjectKeyFrame.Value>
                                                    <x:Boolean>True</x:Boolean>
                                                </DiscreteObjectKeyFrame.Value>
                                            </DiscreteObjectKeyFrame>
                                        </ObjectAnimationUsingKeyFrames>
                                        <ObjectAnimationUsingKeyFrames Storyboard.TargetName="PartCloseButton" Storyboard.TargetProperty="IsHitTestVisible">
                                            <DiscreteObjectKeyFrame KeyTime="0:0:0">
                                                <DiscreteObjectKeyFrame.Value>
                                                    <x:Boolean>False</x:Boolean>
                                                </DiscreteObjectKeyFrame.Value>
                                            </DiscreteObjectKeyFrame>
                                            <DiscreteObjectKeyFrame KeyTime="0:0:0.12">
                                                <DiscreteObjectKeyFrame.Value>
                                                    <x:Boolean>True</x:Boolean>
                                                </DiscreteObjectKeyFrame.Value>
                                            </DiscreteObjectKeyFrame>
                                        </ObjectAnimationUsingKeyFrames>

                                        <!--  Fade in overlay (buttons will be visible as overlay fades in)  -->
                                        <DoubleAnimation
                                            Storyboard.TargetName="OverlayPanel"
                                            Storyboard.TargetProperty="Opacity"
                                            To="1"
                                            Duration="0:0:0.12" />

                                        <!--  hit-testing is enabled via the combined keyframes above after fade completes  -->
                                    </Storyboard>
                                </VisualState>
                            </VisualStateGroup>
                            <!--
                                Dragging states: when IsDragging is true, the tab is slightly scaled down and
                                reduced in opacity to provide visual feedback that it is being dragged.
                            -->
                            <VisualStateGroup x:Name="DraggingStates">
                                <VisualState x:Name="NotDragging">
                                    <Storyboard>
                                        <DoubleAnimation
                                            Storyboard.TargetName="PartRootGrid"
                                            Storyboard.TargetProperty="Opacity"
                                            To="1"
                                            Duration="0:0:0.1" />
                                        <DoubleAnimation
                                            Storyboard.TargetName="PartRootGrid"
                                            Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleX)"
                                            To="1"
                                            Duration="0:0:0.1" />
                                        <DoubleAnimation
                                            Storyboard.TargetName="PartRootGrid"
                                            Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)"
                                            To="1"
                                            Duration="0:0:0.1" />
                                    </Storyboard>
                                </VisualState>
                                <VisualState x:Name="Dragging">
                                    <Storyboard>
                                        <DoubleAnimation
                                            Storyboard.TargetName="PartRootGrid"
                                            Storyboard.TargetProperty="Opacity"
                                            To="0.7"
                                            Duration="0:0:0.1" />
                                        <DoubleAnimation
                                            Storyboard.TargetName="PartRootGrid"
                                            Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleX)"
                                            To="0.95"
                                            Duration="0:0:0.1" />
                                        <DoubleAnimation
                                            Storyboard.TargetName="PartRootGrid"
                                            Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)"
                                            To="0.95"
                                            Duration="0:0:0.1" />
                                    </Storyboard>
                                </VisualState>
                            </VisualStateGroup>
                        </VisualStateManager.VisualStateGroups>
                    </Grid>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>
</ResourceDictionary>
