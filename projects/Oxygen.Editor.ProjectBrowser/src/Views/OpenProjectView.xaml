<?xml version="1.0" encoding="utf-8" ?>

<UserControl
    x:Class="Oxygen.Editor.ProjectBrowser.Views.OpenProjectView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="using:Oxygen.Editor.ProjectBrowser.Controls"
    xmlns:converters="using:DroidNet.Converters"
    xmlns:ctk="using:CommunityToolkit.WinUI.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="using:Oxygen.Editor.ProjectBrowser.Views"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:pbc="using:Oxygen.Editor.ProjectBrowser.Controls"
    xmlns:storage="using:Oxygen.Editor.Storage"
    xmlns:vm="using:Oxygen.Editor.ProjectBrowser.ViewModels"
    x:Name="Root"
    d:DataContext="{d:DesignInstance Type=vm:OpenProjectViewModel}"
    mc:Ignorable="d">

    <UserControl.Resources>
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter" />
        <!-- Converter to bind GridLength <-> double pixel values from ViewModel -->
        <converters:DoubleToGridLengthConverter x:Key="DoubleToGridLengthConverter" />
        <!--  Hover brush for the resizer border  -->
        <SolidColorBrush
            x:Key="ResizerHoverBrush"
            Opacity="0.12"
            Color="{ThemeResource SystemAccentColor}" />
        <!--  Proxy to expose the ViewModel instance to DataTemplates  -->
        <controls:BindingProxy x:Key="ViewModelProxy" Data="{x:Bind ViewModel}" />

        <Style x:Key="HorizontalSeparator" TargetType="Border">
            <Setter Property="Height" Value="1" />
            <Setter Property="Margin" Value="10" />
            <Setter Property="HorizontalAlignment" Value="Stretch" />
            <Setter Property="BorderBrush" Value="{ThemeResource SystemBaseLowColor}" />
            <Setter Property="BorderThickness" Value="0,0,0,1" />
        </Style>
        <Style x:Key="VerticalSeparator" TargetType="Border">
            <Setter Property="Width" Value="1" />
            <Setter Property="Margin" Value="10" />
            <Setter Property="VerticalAlignment" Value="Stretch" />
            <Setter Property="BorderBrush" Value="{ThemeResource SystemBaseLowColor}" />
            <Setter Property="BorderThickness" Value="1,0,0,0" />
        </Style>

        <DataTemplate
            x:Key="FolderTemplate"
            x:DataType="storage:IStorageItem"
            x:DefaultBindMode="OneWay">
            <Grid
                Height="48"
                BorderBrush="{ThemeResource SystemControlForegroundBaseLowBrush}"
                BorderThickness="0,0,0,1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="{Binding Data.NameColumnWidth, Source={StaticResource ViewModelProxy}, Converter={StaticResource DoubleToGridLengthConverter}}" />
                    <ColumnDefinition Width="{Binding Data.DateColumnWidth, Source={StaticResource ViewModelProxy}, Converter={StaticResource DoubleToGridLengthConverter}}" />
                </Grid.ColumnDefinitions>
                <Grid Grid.Column="0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="64" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    <FontIcon
                        Grid.Column="0"
                        VerticalAlignment="Center"
                        FontSize="32"
                        Glyph="&#xE8B7;" />
                    <TextBlock
                        Grid.Column="1"
                        VerticalAlignment="Center"
                        Text="{x:Bind Name, Mode=OneTime}" />
                </Grid>
                <TextBlock
                    x:Name="DateColumnText"
                    Grid.Column="1"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Center"
                    Text="{x:Bind LastAccessTime, Mode=OneTime}" />
            </Grid>
        </DataTemplate>

        <DataTemplate
            x:Key="FileTemplate"
            x:DataType="storage:IStorageItem"
            x:DefaultBindMode="OneWay">
            <Grid
                Height="48"
                BorderBrush="{ThemeResource SystemControlForegroundBaseLowBrush}"
                BorderThickness="0,0,0,1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="{Binding Data.NameColumnWidth, Source={StaticResource ViewModelProxy}, Converter={StaticResource DoubleToGridLengthConverter}}" />
                    <ColumnDefinition Width="{Binding Data.DateColumnWidth, Source={StaticResource ViewModelProxy}, Converter={StaticResource DoubleToGridLengthConverter}}" />
                </Grid.ColumnDefinitions>
                <Grid Grid.Column="0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="64" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    <SymbolIcon
                        Grid.Column="0"
                        VerticalAlignment="Center"
                        Symbol="Document" />
                    <TextBlock
                        Grid.Column="1"
                        VerticalAlignment="Center"
                        Text="{x:Bind Name, Mode=OneTime}" />
                </Grid>
                <TextBlock
                    x:Name="DateColumnText"
                    Grid.Column="1"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Center"
                    Text="{x:Bind LastAccessTime, Mode=OneTime}" />
            </Grid>
        </DataTemplate>

        <local:FileListDataTemplateSelector
            x:Key="FileListDataTemplateSelector"
            FileTemplate="{StaticResource FileTemplate}"
            FolderTemplate="{StaticResource FolderTemplate}" />

    </UserControl.Resources>

    <Grid Margin="20,10" VerticalAlignment="Stretch">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="300" />
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <!--  Title  -->
        <TextBlock
            Grid.Row="0"
            Grid.ColumnSpan="2"
            Margin="0,0,0,20"
            Style="{ThemeResource TitleTextBlockStyle}"
            Text="Open" />

        <pbc:KnownLocationsListView
            Grid.Row="1"
            Grid.Column="0"
            HorizontalAlignment="Stretch"
            VerticalAlignment="Stretch"
            Background="Green"
            IsItemClickEnabled="True"
            ItemClick="OnKnownLocationItemClick"
            ItemsSource="{x:Bind ViewModel.KnownLocations, Mode=OneWay}"
            SelectedItem="{x:Bind ViewModel.SelectedLocation, Mode=TwoWay}"
            SelectionChanged="OnKnownLocationSelectionChanged" />

        <Border
            Grid.Row="1"
            Grid.Column="1"
            Style="{StaticResource VerticalSeparator}" />

        <!--  The right file list view area  -->
        <Grid Grid.Row="1" Grid.Column="2">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!--  Breadcrumb bar  -->
            <Grid Grid.Row="0" Margin="15,0,0,10">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="48" />
                    <ColumnDefinition Width="48" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Button Command="{x:Bind ViewModel.GoToParentFolderCommand, Mode=OneWay}">
                    <SymbolIcon Symbol="Up" />
                </Button>
                <FontIcon
                    Grid.Column="1"
                    Glyph="&#xE838;"
                    Visibility="{x:Bind ViewModel.CurrentFolder, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}" />
                <TextBlock
                    Grid.Column="2"
                    VerticalAlignment="Center"
                    Text="{x:Bind ViewModel.CurrentFolder.Location, Mode=OneWay, FallbackValue={}}" />
            </Grid>

            <!--  Filter bar  -->
            <Grid Grid.Row="1" Margin="15,0,0,20">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <TextBox
                    x:Name="FilterBox"
                    Grid.Column="0"
                    PlaceholderText="Search"
                    Text="{x:Bind ViewModel.FilterText, Mode=TwoWay}"
                    TextChanged="FilterBox_OnTextChanged" />
                <SymbolIcon
                    Grid.Column="1"
                    Margin="20,0,0,0"
                    Symbol="Find" />
            </Grid>

            <Grid Grid.Row="2">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <ScrollViewer
                    x:Name="HeaderScrollViewer"
                    Grid.Row="0"
                    Margin="15,0,15,0"
                    HorizontalScrollBarVisibility="Hidden"
                    HorizontalScrollMode="Enabled"
                    VerticalScrollBarVisibility="Disabled"
                    VerticalScrollMode="Disabled">
                    <!--  Sort column headers  -->
                    <Grid
                        Margin="0,0,0,28"
                        BorderBrush="{ThemeResource SystemControlForegroundBaseLowBrush}"
                        BorderThickness="0,0,0,1">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="{x:Bind ViewModel.NameColumnWidth, Converter={StaticResource DoubleToGridLengthConverter}, Mode=TwoWay}" />
                            <ColumnDefinition Width="{x:Bind ViewModel.DateColumnWidth, Converter={StaticResource DoubleToGridLengthConverter}, Mode=TwoWay}" />
                        </Grid.ColumnDefinitions>

                        <!--  By Name  -->
                        <Button
                            Grid.Column="0"
                            HorizontalAlignment="Stretch"
                            VerticalAlignment="Center"
                            HorizontalContentAlignment="Left"
                            Background="Transparent"
                            BorderThickness="0"
                            Command="{x:Bind ViewModel.ToggleSortByNameCommand, Mode=OneWay}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Margin="20,0,0,0" Text="Name" />
                                <FontIcon
                                    Margin="20,0,20,0"
                                    FontSize="14"
                                    Glyph="&#xE8CB;" />
                            </StackPanel>
                        </Button>

                        <!--  Custom resizer: uses Thumb events to change NameColumnWidth only  -->
                        <controls:ColumnResizer
                            Grid.Column="0"
                            ResizeCompleted="{x:Bind ViewModel.SaveColumnWidths}"
                            TargetWidth="{x:Bind ViewModel.NameColumnWidth, Mode=TwoWay}" />

                        <!--  By date modified  -->
                        <Button
                            Grid.Column="1"
                            HorizontalAlignment="Stretch"
                            VerticalAlignment="Center"
                            HorizontalContentAlignment="Left"
                            Background="Transparent"
                            BorderThickness="0"
                            Command="{x:Bind ViewModel.ToggleSortByDateCommand, Mode=OneWay}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="Date Modified" />
                                <FontIcon
                                    Margin="20,0,20,0"
                                    FontSize="14"
                                    Glyph="&#xE8CB;" />
                            </StackPanel>
                        </Button>

                        <controls:ColumnResizer
                            Grid.Column="1"
                            ResizeCompleted="{x:Bind ViewModel.SaveColumnWidths}"
                            TargetWidth="{x:Bind ViewModel.DateColumnWidth, Mode=TwoWay}" />
                    </Grid>
                </ScrollViewer>

                <!--  Folder/File list view  -->
                <ListView
                    x:Name="FilesList"
                    Grid.Row="1"
                    Margin="15,0,15,0"
                    IsItemClickEnabled="True"
                    ItemClick="ListView_OnItemClickAsync"
                    ItemTemplateSelector="{StaticResource FileListDataTemplateSelector}"
                    ItemsSource="{x:Bind ViewModel.AdvancedFileList, Mode=OneWay}"
                    ScrollViewer.HorizontalScrollBarVisibility="Auto"
                    ScrollViewer.HorizontalScrollMode="Enabled"
                    SelectionMode="Single">
                    <ListView.ItemContainerStyle>
                        <Style TargetType="ListViewItem">
                            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                            <Setter Property="Padding" Value="0" />
                        </Style>
                    </ListView.ItemContainerStyle>
                </ListView>
            </Grid>
        </Grid>
    </Grid>
</UserControl>
